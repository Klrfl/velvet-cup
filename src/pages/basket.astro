---
import Layout from "@/layouts/Layout.astro"
import BasketList from "@/components/BasketList.vue"

import { db } from "@/database/"
import { auth } from "@/lib/auth"

const session = await auth.api.getSession({
	headers: Astro.request.headers,
})

if (!session) {
	if (import.meta.env.DEV) console.error("no session")
	return Astro.redirect("/")
}

const basket = await db
	.selectFrom("baskets as b")
	.leftJoin("menu as m", "m.id", "b.menu_id")
	.leftJoin("menu_variants as mv", (join) =>
		join.onRef("mv.menu_id", "=", "m.id").onRef("mv.id", "=", "b.variant_id")
	)
	.select([
		"b.id",
		"m.name as menu_name",
		"b.quantity",
		"mv.name as variant_name",
		"mv.price",
	])
	.where("user_id", "=", session.user.id)
	.execute()
---

<Layout bodyClass="content-start">
	<header class="main-section">
		<h1 class="text-4xl">Your basket</h1>
	</header>

	<section class="main-section">
		<BasketList basket={basket} client:load />
	</section>
</Layout>
