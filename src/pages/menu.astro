---
import Layout from "@/layouts/Layout.astro"
import MenuItem from "@/components/MenuItem.astro"
import { Input } from "@/components/ui/input"
import { Button } from "@/components/ui/button"
import { Search } from "lucide-vue-next"

import { db } from "@/database/"
import { jsonObjectFrom } from "kysely/helpers/postgres"

const params = Astro.url.searchParams

const searchQuery = params.get("query") ?? ""

let menuQuery = db
	.selectFrom("menu")
	.select((eb) => [
		"menu.id",
		"menu.name",
		"menu.image",
		jsonObjectFrom(
			eb
				.selectFrom("menu_variants as mv")
				.select(["mv.name", "mv.price"])
				.whereRef("mv.menu_id", "=", "menu.id")
				.orderBy("mv.price asc")
				.limit(1)
		).as("variant"),
	])

if (searchQuery !== "") {
	menuQuery = menuQuery.where("menu.name", "ilike", `%${searchQuery}%`)
}

const menus = await menuQuery.where("deleted_at", "is", null).execute()
---

<Layout title="Our menu - Velvet Cup" description="List of our menu">
	<header class="bleed-section grid grid-cols-6">
		<h1 class="text-4xl col-span-3">Our menu</h1>

		<form class="flex gap-4 col-span-3">
			<Input
				type="search"
				name="query"
				id="query"
				placeholder="what are you looking for?"
				default-value={searchQuery}
				required
			/>
			<Button type="submit">
				<Search />
			</Button>
		</form>
	</header>

	<section class="bleed-section">
		<ul class="grid grid-cols-3 gap-4">
			{menus.map((menu) => <MenuItem {menu} />)}
		</ul>
	</section>
</Layout>
